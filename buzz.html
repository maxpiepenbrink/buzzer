<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Buzzer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-Zenh87qX5JnK2Jl0vWa8Ck2rdkQ2Bzep5IDxbcnCeuOxjzrPF/et3URy9Bv1WTRi" crossorigin="anonymous">
</head>

<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"
        crossorigin="anonymous"></script>

    <div class="container">
        <div class="row justify-content-md-center">
            <div class="col-md-auto">
                <div class="container border border-3 shadow-sm p-3 mb-5 bg-body rounded">
                    <h1>Buzzer Beta!</h1>
                    <div class="input-group mb-3">
                        <input id="roomcode" class="form-control" type="text" placeholder="room code">
                        <button class="btn btn-outline-secondary" id="join-room" type="button">Join Room</button>
                        <button class="btn btn-outline-secondary" id="create-room" type="button">Create Room</button>
                        <button class="btn btn-outline-secondary" id="leave-room" type="button">Leave Room</button>
                    </div>
                    <div class="input-group mb-3">
                        <button class="btn btn-outline-primary" id="send-name" type="button">Set Display Name</button>
                        <input id="name" type="text" class="form-control" placeholder="Display Name"
                            aria-label="Username" aria-describedby="basic-addon1" value="New Player">
                    </div>
                </div>
            </div>

            <div class="col-md-auto">
                <div class="container border border-3 shadow-sm p-3 mb-5 bg-body rounded">
                    <h3>Admin Controls</h3>
                    <div class="form-check form-switch admin-button">
                        <input class="form-check-input" type="checkbox" role="switch" id="admin_buzzer_lock" disabled>
                        <label class="form-check-label" for="flexSwitchCheckDefault">Buzzer Lock üîí</label>
                    </div>
                    <button class="btn btn-outline-secondary" id="reset-buzzers" type="button">Reset Buzzers</button>
                    <div class="form-check admin-button">
                        <input class="form-check-input" type="radio" name="flexRadioDefault" id="admin_first_to_buzz"
                            checked disabled>
                        <label class="form-check-label" for="flexRadioDefault2">
                            First To Buzz
                        </label>
                    </div>
                    <div class="form-check admin-button">
                        <input class="form-check-input" type="radio" name="flexRadioDefault" id="admin_buzzer_race"
                            disabled>
                        <label class="form-check-label" for="flexRadioDefault2">
                            Buzzer Race
                        </label>
                    </div>
                </div>
            </div>
            <div class="col-md">
                <div class="container border border-3 shadow-sm p-3 mb-5 bg-body rounded">
                    <h3>Players</h3>
                    <ul class="list-group" id="player-list-display">
                        <li class="list-group-item">An item
                            <span class="badge bg-primary rounded-pill">üîî</span>
                        </li>
                        <li class="list-group-item list-group-item-danger">A second item</li>
                        <li class="list-group-item">A third item</li>
                        <li class="list-group-item">A fourth item</li>
                        <li class="list-group-item">And a fifth one</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <textarea id="chat" style="display:block; width:600px; height:400px; box-sizing: border-box" cols="30"
        rows="10"></textarea>


    <script>
        const roomcode = document.querySelector("#roomcode");
        const name_field = document.querySelector("#name");

        const join_btn = document.querySelector("#join-room");
        const create_btn = document.querySelector("#create-room");
        const leave_btn = document.querySelector("#leave-room");

        const textarea = document.querySelector("#chat");
        const input = document.querySelector("#input");
        const send_name = document.querySelector("#send-name");

        const admin_buzzer_lock = document.querySelector("#admin_buzzer_lock");
        const admin_first_to_buzz = document.querySelector("#admin_first_to_buzz");
        const admin_buzzer_race = document.querySelector("#admin_buzzer_race");

        const player_list = document.querySelector("#player-list-display");

        const active_when_unjoined = [join_btn, create_btn, roomcode];
        const active_when_joined = [leave_btn, send_name];
        const admin_buttons = [admin_buzzer_lock, admin_first_to_buzz, admin_buzzer_race];

        let decorate_socket = function (websocket) {
            websocket["update_name"] = function (new_name) {
                let set_name = {
                    op: "set_name",
                    value: new_name
                };
                websocket.send(JSON.stringify(set_name));
            }

            return websocket
        }

        let client_state = {
            // 0 - disconnected, 1 - connecting, 2 - connected
            connection_state: 0,
            my_id: -1,
            current_websocket: null,
            pending_messages: [],
        };

        let update_room_state = function (state) {
            // set basic variables
            roomcode.value = state.room_id;

            // if the captain status has changed then we wanna re-evaluate the disabled-ness of 
            // some buttons
            let captain = state.room_captain;

            admin_buttons.map(x => x.disabled = captain != client_state.my_id);

            // show players
            let new_player_html = Object.keys(state.participants).map(id => {
                let name = state.participants[id].name;
                if (id == client_state.my_id) {
                    name += " (you)"
                }
                if (id == captain) {
                    name = "‚≠ê" + name;
                }
                //let badge = "";
                let badge = `<span class="badge bg-primary rounded-pill">1</span>`;
                return `<li class="list-group-item">${name} ${badge}</li>`;
            }).join('');
            player_list.innerHTML = new_player_html;
        }

        let room_behavior = async function () {
            active_when_unjoined.map(x => x.disabled = true);
            active_when_joined.map(x => x.disabled = false);
            admin_buttons.map(x => x.disabled = true);

            while (client_state.connection_state == 1) {
                await new Promise(resolve => setTimeout(resolve, 50));
                // wait to connect
            }

            if (client_state.connection_state == 2) {
                // we're joining! otherwise something went wrong
                client_state.current_websocket.update_name(name_field.value);
            }

            while (client_state.connection_state == 2) {
                // 50ms tick
                await new Promise(resolve => setTimeout(resolve, 5));

                while (client_state.pending_messages.length > 0) {
                    let msg = client_state.pending_messages.shift();
                    if (msg["your_id"]) {
                        client_state.my_id = msg.your_id;
                        console.log("received authoritative id: " + client_state.my_id);
                    } else if (msg["room_id"]) {
                        update_room_state(msg);
                    }

                }
            }

            console.log("cleaning up");
            active_when_unjoined.map(x => x.disabled = false);
            active_when_joined.map(x => x.disabled = true);
            admin_buttons.map(x => x.disabled = true);
        };

        // clicking leave wont trigger cleanup directly, that will happen via
        // the websocket onclose callback.
        let on_leave = function (e) {
            client_state.current_websocket.close();
        }
        leave_btn.addEventListener("click", on_leave);

        let connect_behavior = function (room_code) {
            const websocket = decorate_socket(new WebSocket("ws://localhost:8080/buzzer?room=" + room_code));

            client_state.current_websocket = websocket;
            client_state.connection_state = 1;

            websocket.onopen = function () {
                console.log("connection opened");
                client_state.connection_state = 2;
            }

            websocket.onclose = function () {
                console.log("connection closed");
                client_state.connection_state = 0;
                client_state.current_websocket = null;
            }

            websocket.onmessage = function (e) {
                client_state.pending_messages.push(JSON.parse(e.data));
                textarea.value += e.data + "\r\n"; // todo: temporary
            }

            room_behavior();
        }

        create_btn.addEventListener("click", function (e) {
            connect_behavior("new");
        });

        join_btn.addEventListener("click", function (e) {
            connect_behavior(roomcode.value);
        });

        send_name.addEventListener("click", function (e) {
            if (client_state.connection_state == 2) {
                client_state.current_websocket.update_name(name_field.value);
            }
        })

        /*
        create_btn.addEventListener("click", function (e) {
            this.disabled = true;

            const websocket = new WebSocket("ws://localhost:8080/buzzer?room=new");

            websocket.onopen = function () {
                console.log("connection opened");
                let set_name = {
                    op: "set_name",
                    value: name.value
                };
                websocket.send(JSON.stringify(set_name));
            }

            const btn = this;

            websocket.onclose = function () {
                console.log("connection closed");
                btn.disabled = false;
            }

            websocket.onmessage = function (e) {
                console.log("received message: " + e.data);
                //let payload = JSON.parse(e.data);
                textarea.value += e.data + "\r\n";
            }

            send_name.addEventListener("click", function (e) {
                let set_name = {
                    op: "set_name",
                    value: name.value
                };
                websocket.send(JSON.stringify(set_name));
            })

            input.onkeydown = function (e) {
                if (e.key == "Enter") {
                    websocket.send(input.value);
                    input.value = "";
                }
            }
        }); */
    </script>
</body>

</html>